---
title: "TCGA_SKCM_Report_DZ_2"
author: "Dmitry Zubkov"
date: "December 13, 2022"
output: md_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(factoextra)
library(ggbiplot)
library(ComplexHeatmap)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


## Transcriptomics data

```{r transcriptomics}

df.t <- 
  read_tsv("../raw/data_mrna_seq_v2_rsem.txt") %>%
  select(-Hugo_Symbol)

zeros <- apply(as.matrix(df.t[-1]), 1, function(x) all(x == 0))

df.t <- df.t[!zeros, ]

```

```{r transcriptomics_transformation}

mat.raw <- t(df.t[-1])
colnames(mat.raw) <- df.t$Entrez_Gene_Id
rownames(mat.raw) <- colnames(df.t)[-1]

imp_na <- function(x) {
  x[is.na(x)] <- min(x, na.rm = T)/2
  return(x)
}

mat.log <- mat.raw
mat.log[mat.log == 0] <- NA
mat.log <- 
  apply(mat.log, 2, imp_na) %>%
  log2() %>%
  apply(2, function(x) x - median(x))
  
features <- 
  apply(mat.log, 2, sd, na.rm = T) %>%
  sort(decreasing = T) %>%
  names() %>%
  .[1:1500]

mat <- mat.log[, features]
  
```

```{r pca, eval = FALSE}
df.pca.1 <- prcomp(mat, scale = F, rank = 10)
df.pca.2 <- prcomp(mat, scale = T, rank = 10)
fviz_pca_ind(df.pca.1, geom.ind = "point")
fviz_pca_ind(df.pca.2, geom.ind = "point")
```


```{r clust, eval = FALSE}

hc <-
  mat %>%
  #scale() %>%
  dist(method = "euclidean") %>%
  hclust(method = "average")

```

```{r clust_plot, eval = FALSE}

fviz_dend(hc, show_labels = F)

grp <- cutree(hc, k = 2)

fviz_cluster(list(data = mat, cluster = grp),
             palette = "Set1",
             ellipse.type = "convex",
             show.clust.cent = FALSE,
             labelsize = 0,
             ggtheme = theme_minimal())
```


```{r heatmap}
Heatmap(mat)
```